#!/bin/bash

die() {
  echo "$@" 2>&1
  exit 1
}

export QTDIR=${QTDIR:-/home/y/third-party/qt5-clang-tsan-build}

if [ ! -d "QTDIR" ]
then
  die "Can't find QTDIR: $QTDIR"
fi

export QMAKESPEC=${QMAKESPEC:-linux-clang}
export PATH=$QTDIR/bin:$PATH

echo "QTDIR is set to: $QTDIR"
echo "QMAKESPEC is set to: $QMAKESPEC"

CFLAGS="-fsanitize=thread -fno-omit-frame-pointer"
LFLAGS="-fsanitize=thread"

exec qmake QMAKE_CXXFLAGS+="$CFLAGS" \
    QMAKE_CFLAGS+="$CFLAGS" \
    QMAKE_LFLAGS+="$LFLAGS" \
    CONFIG+=debug \
    "$@"
